<!DOCTYPE html>
<html>

<head>
    <title>Blob Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let paused = false;

        let points1, points2, blobs1, blobs2, diffLines, background;

        let data1 = [];
        data1.length = 40;
        let data2 = [];
        data2.length = 40;

        let backgroundImg = null;
        let images1 = [];
        let images2 = [];

        let drawIndex = 0;

        const CANVAS_WIDTH = 1000;
        const CANVAS_HEIGHT = 500;
        function preload() {
            let count = 0;
            backgroundImg = loadImage(`./blob-images/site.png`);
            for (let i = 0; i <= 310; i++) {
                images1.push(loadImage(`./blob-images/blobs-1-frame-${i}.png`));
            }
            for (let j = 0; j <= 300; j++) {
                images2.push(loadImage(`./blob-images/blobs-2-frame-${j}.png`));
            }
        }

        function setup() {
            let data1Promise = fetch("./blob-points-1.csv")
                .then(response => response.text())
                .then(txt => Papa.parse(txt))
                .then(parsed => {
                    parsed.data.forEach(point => {
                        try {
                            const index = parseInt(point[0]);
                            if (!isNaN(index)) {
                                if (data1[index]) data1[index].push([ point[1], point[2], point[3] ])
                                else data1[index] = [];
                            }
                        } catch(err) {}
                    });
                })
                .catch(err => console.error(err));
            let data2Promise = fetch("./blob-points-2.csv")
                .then(response => response.text())
                .then(txt => Papa.parse(txt))
                .then(parsed => {
                    parsed.data.forEach(point => {
                        try {
                            const index = parseInt(point[0]);
                            if (!isNaN(index)) {
                                if (data2[index]) data2[index].push([ point[1], point[2], point[3] ])
                                else data2[index] = [];
                            }
                        } catch(err) {}
                    });
                })
                .catch(err => console.error(err));
            Promise.all([data1Promise, data2Promise])
                .then(() => {
                    if (data1.length < data2.length) {
                        let saved = [...data1];
                        data1 = data2;
                        data2 = saved;
                    }
                    console.log("Loaded in data1");
                    // console.log(data1);
                    console.log("Loaded in data2");
                    // console.log(data2);
                });
            createToggleButtons();
            createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
        }
        
        function draw() {
            if (paused || !data1[0] || !data2[0]) return;
            drawIndex += 0.5;
            let diffStep = data2[0].length / data1[0].length;
            if (drawIndex > 309) drawIndex = 0;
            
            clear();
            colorMode(RGB, 255);
            let index1 = Math.floor(drawIndex);
            let index2 = Math.floor(drawIndex * diffStep);
            if (background.checked()) {
                tint(255);
                image(backgroundImg, 0, 0);
            }
            if (blobs1.checked()) {
                tint(255, 126);
                image(images1[index1], 0, 0);
            }
            if (blobs2.checked()) {
                tint(255, 126);
                image(images2[index2], 0, 0);
            }

            let middle = findMiddle(index1, index2);
            let middleX = middle[0] + CANVAS_WIDTH / 3 - 10;
            let middleY = middle[1] + CANVAS_HEIGHT / 2 - 10;

            strokeWeight(5);
            colorMode(RGB, 255, 255, 255, 1);
            if (diffLines.checked()) {
                for(let k = 0; k <= 40; k++) {
                    let x1 = +data1[k][index1][1] + CANVAS_WIDTH / 3 - 10;
                    let y1 = +data1[k][index1][2] + CANVAS_HEIGHT / 2 - 10;
                    let x2 = +data2[k][index2][1] + CANVAS_WIDTH / 3 - 10;
                    let y2 = +data2[k][index2][2] + CANVAS_HEIGHT / 2 - 10;
                    if (distance(middleX, x1, middleY, y1) > distance(middleX, x2, middleY, y2)) {
                        stroke(255, 0, 0, 0.5);
                    } else {
                        stroke(48, 213, 200, 0.5);
                    }
                    line(x1, y1, x2, y2);
                }
            }
            
            if (points1.checked()) {
                // stroke(255, 0, 0, 1);
                stroke(0, 255, 0, 1);
                for (let i = 0; i <= 40; i++) {
                    let x = +data1[i][index1][1] + CANVAS_WIDTH / 3 - 10;
                    let y = +data1[i][index1][2] + CANVAS_HEIGHT / 2 - 10;
                    point(x,y);
                }
            }

            if (points2.checked()) {
                stroke(255, 165, 0, 1);
                for (let j = 0; j <= 40; j++) {
                    let x = +data2[j][index2][1] + CANVAS_WIDTH / 3 - 10;
                    let y = +data2[j][index2][2] + CANVAS_HEIGHT / 2 - 10;
                    point(x,y);
                }
            }

            stroke(255, 0, 0);
            line(0, backgroundImg.height, backgroundImg.width * (drawIndex / 309), backgroundImg.height);
        }

        function createToggleButtons() {
            points1 = createCheckbox("Point 1", true);
            points2 = createCheckbox("Points 2", true);
            diffLines = createCheckbox("Line Differences", false);
            blobs1 = createCheckbox("Blob Images 1", false);
            blobs2 = createCheckbox("Blob Images 2", false);
            background = createCheckbox("Background Image", true);
        }

        function findMiddle(index1, index2) {
            let smallestX = 10000000;
            let largestX = 0;
            let smallestY = 10000000;
            let largestY = 0;
            for (let i = 0; i <= 40; i++) {
                let data1X = +data1[i][index1][1];
                let data1Y = +data1[i][index1][2];
                let data2X = +data2[i][index2][1];
                let data2Y = +data2[i][index2][2];

                if (data1X < smallestX) smallestX = data1X;
                if (data2X < smallestX) smallestX = data2X;
                if (data1X > largestX) largestX = data1X;
                if (data2X > largestX) largestX = data2X;

                if (data1Y < smallestY) smallestY = data1Y;
                if (data2Y < smallestY) smallestY = data2Y;
                if (data1Y > largestY) largestY = data1Y;
                if (data2Y > largestY) largestY = data2Y;
            }
            return [ (largestX + smallestX) / 2, (largestY + smallestY) / 2]
        }

        function distance (x1, x2, y1, y2) {
            return Math.sqrt(Math.pow((x2 - x1), 2) + Math.pow((y2 - y1), 2));
        }

        function keyPressed(event) {
            if (event.keyCode === 32) paused = !paused;
            if (event.keyCode === LEFT_ARROW) drawIndex -= 20;
            if (event.keyCode === RIGHT_ARROW) drawIndex += 20;
            if (drawIndex < 0) drawIndex = 0;
            if (drawIndex > 309) drawIndex = 0;
        }
    </script>
</head>

<body>
    <main></main>
</body>

</html>